const pkg = require('./package.json');
const path = require('path');
const busybox = require('../..');

const modulePath = busybox.utils.node.getModulePath('webpack', __dirname);
if (!modulePath) {
  console.log('modulePath not found!');
  process.exit();
}

const webpack = require(modulePath);
console.log(webpack);

const production = process.env.NODE_ENV === 'production' || false;

const banner = `clipboard.js v${pkg.version}
https://zenorocha.github.io/clipboard.js

Licensed MIT Â© Zeno Rocha`;

// !!!NOTICE:
// 1. webpack@"^3.10.0" is needed
// 2. command should be triggered in current dir
const config = {
  entry: './src/index.js',
  output: {
    filename: production ? 'debug.out.js' : 'debug.out.js',
    path: path.resolve(__dirname, 'dist'),
    library: 'debug',
    libraryTarget: 'umd'
    // libraryTarget: 'cmd'
  },
  module: {
    rules: [{
      test: /\.js$/,
      exclude: /node_modules/,
      loader: 'babel-loader'
    }]
  },
  plugins: production ? [
    new webpack.optimize.UglifyJsPlugin({
      beautify: false,
      mangle: {
        screw_ie8: true,
        keep_fnames: true
      },
      compress: {
        screw_ie8: true
      },
      comments: false
    }),
    new webpack.BannerPlugin({
      banner
    })
  ] : [
    new webpack.BannerPlugin({
      banner
    })
  ]
};

webpack(config, (err, stats) => {
  if (err) {
    console.log('error:');
    console.log(err);
    return;
  }
  console.log(stats);
})